# util.py
import pathlib
import google.generativeai as genai
from typing import Optional, Dict, Any
import json
import time
import streamlit as st
import os
import random

def upload_file_to_gemini(file) -> Optional[Dict[str, Any]]:
  """يرفع ملف إلى Google Gemini."""
  try:
      temp_dir = pathlib.Path("temp")
      temp_dir.mkdir(exist_ok=True)
      file_path = temp_dir / file.name
      with open(file_path, "wb") as f:
          f.write(file.getbuffer())
      uploaded_file = genai.upload_file(file_path)
      os.remove(file_path)  # إزالة الملف من الجهاز المحلي بعد الرفع
      return uploaded_file
  except Exception as e:
      st.error(f"خطأ أثناء رفع الملف: {e}")
      return None

def poll_file_processing(uploaded_file) -> Optional[Dict[str, Any]]:
  """يتابع حالة الملف المرفوع حتى تكتمل معالجته."""
  try:
      with st.spinner('جاري معالجة الملف...'):
          while uploaded_file.state.name == "PROCESSING":
              time.sleep(1)
              uploaded_file = genai.get_file(uploaded_file.name)
          if uploaded_file.state.name == "ACTIVE":
              st.success("اكتملت معالجة الملف.")
              return uploaded_file
          elif uploaded_file.state.name == "FAILED":
              st.error("فشلت معالجة الملف.")
              return None
          else:
              st.error(f"حالة ملف غير متوقعة: {uploaded_file.state.name}")
              return None
  except Exception as e:
      st.error(f"خطأ أثناء معالجة الملف: {e}")
      return None

def generate_transcription(model: Any, media_file) -> Optional[str]:
  """ينشئ تحليلاً على مستوى الخبراء لمكالمة العميل مع رؤى استراتيجية."""
  try:
      prompt = """
# تحليل استراتيجي لمكالمة عميل

أنت عالم متخصص في علم النفس التطبيقي وخبير استثنائي في تحليل سلوك العملاء واستراتيجيات المبيعات المتقدمة. مهمتك هي تحليل التسجيل الصوتي لمكالمة العميل وتقديم رؤى عميقة تساعد في اتخاذ القرارات الاستراتيجية.

## التوجيهات الرئيسية

- ركز على التحليل العميق والرؤى غير البديهية التي تؤثر مباشرة على اتخاذ القرارات.
- تجنب التكرار والمعلومات السطحية. كل نقطة يجب أن تضيف قيمة فريدة للتحليل.
- كن مبدعًا في تحليلك. إذا رأيت نمطًا أو استراتيجية غير تقليدية قد تكون فعالة، اشرحها بالتفصيل.
- تذكر أن الهدف النهائي هو تحسين عملية اتخاذ القرار وزيادة فرص نجاح المبيعات.

## هيكل التحليل

### 1. الرؤية الاستراتيجية
- تقييم موجز لأهمية هذا العميل وإمكانات الصفقة.
- التنبؤ الرئيسي: ما هو القرار الأكثر احتمالاً للعميل وكيف يمكن التأثير عليه؟

### 2. تحليل شخصية العميل وعملية اتخاذ القرار
- النمط الشخصي ونقاط التأثير الرئيسية.
- العوامل الخفية التي تؤثر على قرارات العميل.
- كيف يمكن استخدام هذه المعلومات لتحسين استراتيجية المبيعات؟

### 3. تحليل اللغة والسلوك
- الإشارات اللغوية والسلوكية الحاسمة وتأثيرها على المفاوضات.
- التناقضات أو النقاط الغامضة في كلام العميل وكيفية استغلالها.

### 4. الاحتياجات والدوافع الحقيقية
- تحليل عميق للاحتياجات غير المعلنة والدوافع الخفية.
- كيف يمكن ربط هذه الاحتياجات بالحل المقدم بطريقة مبتكرة؟

### 5. نقاط القوة والضعف في نهج المبيعات الحالي
- تحليل نقدي لأداء مندوب المبيعات.
- اقتراحات محددة وغير تقليدية لتحسين النهج.

### 6. استراتيجية التفاوض المقترحة
- خطة تفاوض مخصصة بناءً على تحليل شخصية العميل واحتياجاته.
- تكتيكات مبتكرة للتغلب على الاعتراضات المحتملة.

### 7. تحليل المخاطر والفرص
- تقييم دقيق لاحتمالات نجاح الصفقة مع تبرير.
- الفرص غير المستغلة والمخاطر غير المتوقعة.

### 8. خطة العمل الاستراتيجية
- الخطوات الحاسمة المطلوبة لتحريك الصفقة إلى الأمام.
- توقيت وترتيب هذه الخطوات لتحقيق أقصى تأثير.

### 9. مؤشرات الأداء الرئيسية والنقاط الحاسمة
- المؤشرات التي يجب مراقبتها لتقييم تقدم العلاقة مع العميل.
- نقاط التحول المحتملة في عملية البيع وكيفية الاستعداد لها.

### 10. الرؤية المستقبلية
- التنبؤ بتطور العلاقة مع العميل على المدى الطويل.
- كيف يمكن استخدام هذه الصفقة كنقطة انطلاق لفرص أكبر؟

ليس بالضرورة أن تلتزم بالتقسيم السابق فأنت لديك حرية باختيار تقسيم افضل إن وجد.
قدم تحليلك الآن، مع التركيز على الرؤى العميقة والقابلة للتنفيذ التي ستؤثر مباشرة على نجاح المبيعات. تذكر أن كل نقطة يجب أن تكون ذات صلة مباشرة باتخاذ القرارات الاستراتيجية:
"""
      responses = model.generate_content([media_file, prompt])
      if responses.text:
          return responses.text.strip()
      else:
          return "لم يتم استلام استجابة من النموذج."
  except Exception as e:
      return f"حدث خطأ أثناء إنشاء التحليل: {e}"